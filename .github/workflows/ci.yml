name: Monorepo CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - "*"

env:
  PNPM_VERSION: 10.19.0
  GO_VERSION: "1.22"
  PYTHON_VERSION: "3.11"

jobs:
  node:
    name: TypeScript build & test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Turbo test
        run: pnpm turbo run test --continue
      - name: Turbo build
        run: pnpm turbo run build --continue

  go:
    name: Go services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [pricing-go, rules-go]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Go test
        working-directory: services/${{ matrix.service }}
        run: go test ./...

  rust:
    name: Rust services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [compositor-rust, manufacturing-rust]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cargo test
        working-directory: services/${{ matrix.service }}
        run: cargo test --locked

  python:
    name: AI advisor tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install deps
        working-directory: services/ai-python
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: pytest
        working-directory: services/ai-python
        run: pytest

  helm:
    name: Helm lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
      - name: Lint gateway chart
        working-directory: infra/helm/gateway
        run: |
          helm dependency update
          helm lint . -f ../values.example.yaml

  shell_bundle:
    name: Shell bundle stats
    needs: node
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Build shell bundle with analyzer
        run: ANALYZE=true pnpm --filter @repo/shell build
      - name: Upload analyzer artifact
        uses: actions/upload-artifact@v4
        with:
          name: shell-bundle-analyzer
          path: apps/shell/.next/analyze
