generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters", "postgresExtensions"]
  output          = "../generated/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  relationMode = "prisma"
  extensions = [
    pgvector(schema: "public"),
    citext(schema: "public")
  ]
}

enum ModuleCategory {
  GALLEY
  ISLAND
  L_SHAPE
}

enum ManufacturingStatus {
  PENDING
  READY
  COMPLETE
  FAILED
}

model CatalogModule {
  id           String           @id @db.Text
  sku          String           @unique @db.Citext
  name         String
  category     ModuleCategory
  summary      String?
  heroImageUrl String?
  basePrice    Int
  finishes     CatalogFinish[]
  sprites      ModuleSprite[]
  configurations ConfigurationSnapshot[]
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
}

model CatalogFinish {
  id             String         @id @db.Text
  moduleId       String         @db.Text
  module         CatalogModule  @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  label          String
  helper         String?
  costDelta      Int
  leadTimeWeeks  Int
  swatchAssetUrl String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([moduleId, label])
}

model ModuleSprite {
  id        String        @id @db.Text
  moduleId  String        @db.Text
  module    CatalogModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  variant   String        @default("base")
  sortOrder Int
  bucket    String
  objectKey String
  width     Int
  height    Int
  createdAt DateTime       @default(now())

  @@index([moduleId, variant, sortOrder])
}

model ConfigurationSnapshot {
  id           String             @id @default(cuid())
  moduleId     String             @db.Text
  module       CatalogModule      @relation(fields: [moduleId], references: [id])
  finishId     String             @db.Text
  finish       CatalogFinish      @relation(fields: [finishId], references: [id])
  priceCents   Int
  metadata     Json               @default(json("{}"))
  version      Int                @default(1)
  sealedAt     DateTime?
  adjustments  PricingAdjustment[]
  suggestions  AiSuggestion[]
  embedding    DesignEmbedding?
  manufacturingJobs ManufacturingJob[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
}

model PricingAdjustment {
  id               String                @id @default(cuid())
  configurationId  String                @db.Text
  configuration    ConfigurationSnapshot @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  label            String
  amount           Int
}

model AiSuggestion {
  id               String                @id @default(cuid())
  configurationId  String                @db.Text
  configuration    ConfigurationSnapshot @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  title            String
  rationale        String
  accepted         Boolean               @default(false)
  rank             Int                   @default(0)
  createdAt        DateTime              @default(now())
}

model DesignEmbedding {
  id               String                @id @default(cuid())
  configurationId  String                @unique @db.Text
  configuration    ConfigurationSnapshot @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  embedding        Unsupported("vector")
  dimensions       Int
  similarityThreshold Float              @default(0.85)
  createdAt        DateTime              @default(now())
}

model ManufacturingJob {
  id               String                @id @default(cuid())
  configurationId  String                @db.Text
  configuration    ConfigurationSnapshot @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  status           ManufacturingStatus   @default(PENDING)
  bomUrl           String?
  cncUrl           String?
  estimatedMinutes Int
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  @@index([status, createdAt])
}
